<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS DZ | المخزون</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="assets/logo.png" alt="POS DZ" class="sidebar-logo">
            <h3>POS DZ</h3>
        </div>
        <ul class="sidebar-menu">
            <li><a href="sale.html"><i class="fas fa-shopping-cart"></i> <span>البيع</span></a></li>
            <li class="active"><a href="inventory.html"><i class="fas fa-boxes"></i> <span>المخزون</span></a></li>
            <li><a href="customers.html"><i class="fas fa-users"></i> <span>الزبائن</span></a></li>
            <li><a href="suppliers.html"><i class="fas fa-truck"></i> <span>الموردين</span></a></li>
            <li><a href="reports.html"><i class="fas fa-chart-bar"></i> <span>التقارير</span></a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> <span>الإعدادات</span></a></li>
            <li><a href="users.html"><i class="fas fa-user-cog"></i> <span>المستخدمين</span></a></li>
            <li class="logout"><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>خروج</span></a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">إدارة المخزون</div>
            <div class="datetime" id="datetime"></div>
            <div class="user-info" id="userInfo"></div>
        </div>

        <div class="inventory-container">
            <div class="inventory-header">
                <button class="btn-primary" onclick="showAddProductModal()"><i class="fas fa-plus"></i> إضافة منتج</button>
            </div>

            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchProduct" placeholder="بحث عن منتج..." onkeyup="filterProducts()">
            </div>

            <table class="data-table" id="productsTable">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الباركود</th>
                        <th>السعر</th>
                        <th>الكمية</th>
                        <th>الوحدة</th>
                        <th>التصنيف</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <h3 id="productModalTitle">إضافة منتج</h3>
            <form id="productForm">
                <input type="hidden" id="productId">
                <label>الاسم:</label>
                <input type="text" id="productName" required>
                <label>الباركود:</label>
                <input type="text" id="productBarcode">
                <label>السعر:</label>
                <input type="number" id="productPrice" step="0.01" required>
                <label>الكمية:</label>
                <input type="number" id="productQuantity" step="0.01" required>
                <label>الوحدة:</label>
                <select id="productUnit">
                    <option value="قطعة">قطعة</option>
                    <option value="كيلو">كيلو</option>
                    <option value="غرام">غرام</option>
                    <option value="لتر">لتر</option>
                    <option value="علبة">علبة</option>
                    <option value="كرتون">كرتون</option>
                </select>
                <label>التصنيف:</label>
                <select id="productCategory"></select>
                <label>تاريخ الانتهاء:</label>
                <input type="date" id="productExpiry">
                <button type="submit" class="btn-primary">حفظ</button>
                <button type="button" class="btn-cancel" onclick="closeProductModal()">إلغاء</button>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let products = [];
        let categories = [];

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadCurrentUser();
            loadProducts();
            loadCategoriesSelect();
        });

        function loadProducts() {
            products = JSON.parse(localStorage.getItem('products')) || [];
            renderProducts(products);
        }

        function renderProducts(productsArray) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            productsArray.forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.barcode || ''}</td>
                    <td>${p.price}</td>
                    <td>${p.quantity}</td>
                    <td>${p.unit || 'قطعة'}</td>
                    <td>${p.category || ''}</td>
                    <td>
                        <button class="btn-edit" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }

        function filterProducts() {
            const search = document.getElementById('searchProduct').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) || (p.barcode && p.barcode.toLowerCase().includes(search))
            );
            renderProducts(filtered);
        }

        function showAddProductModal() {
            document.getElementById('productModalTitle').innerText = 'إضافة منتج';
            document.getElementById('productId').value = '';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').style.display = 'flex';
        }

        function loadCategoriesSelect() {
            categories = JSON.parse(localStorage.getItem('categories')) || [];
            const select = document.getElementById('productCategory');
            select.innerHTML = '<option value="">اختر تصنيف</option>' + 
                categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const product = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('productName').value,
                barcode: document.getElementById('productBarcode').value,
                price: parseFloat(document.getElementById('productPrice').value),
                quantity: parseFloat(document.getElementById('productQuantity').value),
                unit: document.getElementById('productUnit').value,
                category: document.getElementById('productCategory').options[document.getElementById('productCategory').selectedIndex]?.text || '',
                expiry: document.getElementById('productExpiry').value || null
            };

            let products = JSON.parse(localStorage.getItem('products')) || [];
            if (id) {
                const index = products.findIndex(p => p.id == id);
                if (index !== -1) products[index] = product;
            } else {
                products.push(product);
            }
            localStorage.setItem('products', JSON.stringify(products));
            closeProductModal();
            loadProducts();
        });

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                document.getElementById('productModalTitle').innerText = 'تعديل منتج';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productBarcode').value = product.barcode || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productQuantity').value = product.quantity;
                document.getElementById('productUnit').value = product.unit || 'قطعة';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productExpiry').value = product.expiry || '';
                document.getElementById('productModal').style.display = 'flex';
            }
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من الحذف؟')) {
                products = products.filter(p => p.id !== id);
                localStorage.setItem('products', JSON.stringify(products));
                loadProducts();
            }
        }
    </script>
</body>
</html>
