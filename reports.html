<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS DZ | التقارير</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="assets/logo.png" alt="POS DZ" class="sidebar-logo">
            <h3>POS DZ</h3>
        </div>
        <ul class="sidebar-menu">
            <li><a href="sale.html"><i class="fas fa-shopping-cart"></i> <span>البيع</span></a></li>
            <li><a href="inventory.html"><i class="fas fa-boxes"></i> <span>المخزون</span></a></li>
            <li><a href="customers.html"><i class="fas fa-users"></i> <span>الزبائن</span></a></li>
            <li><a href="suppliers.html"><i class="fas fa-truck"></i> <span>الموردين</span></a></li>
            <li class="active"><a href="reports.html"><i class="fas fa-chart-bar"></i> <span>التقارير</span></a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> <span>الإعدادات</span></a></li>
            <li><a href="users.html"><i class="fas fa-user-cog"></i> <span>المستخدمين</span></a></li>
            <li class="logout"><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>خروج</span></a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">التقارير والديون</div>
            <div class="datetime" id="datetime"></div>
            <div class="user-info" id="userInfo"></div>
        </div>

        <div class="reports-container">
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>عدد المدينين</h3>
                    <div class="value" id="debtorsCount">0</div>
                </div>
                <div class="summary-card">
                    <h3>إجمالي الديون</h3>
                    <div class="value" id="totalDebts">0 دج</div>
                </div>
            </div>

            <div class="report-filters">
                <select id="reportType">
                    <option value="daily">يومي</option>
                    <option value="weekly">أسبوعي</option>
                    <option value="monthly">شهري</option>
                    <option value="yearly">سنوي</option>
                </select>
                <input type="date" id="reportDate">
                <button class="btn-primary" onclick="loadReport()">عرض</button>
                <button class="btn-secondary" onclick="printReport()"><i class="fas fa-print"></i> طباعة</button>
            </div>

            <div id="reportResult" class="report-result"></div>

            <h3 style="margin-top: 20px;">الديون المستحقة</h3>
            <table class="data-table" id="debtsTable">
                <thead>
                    <tr>
                        <th>الزبون</th>
                        <th>المبلغ</th>
                        <th>المتبقي</th>
                        <th>تاريخ الاستحقاق</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="debtsTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="payDebtModal" class="modal">
        <div class="modal-content">
            <h3>تسديد دين</h3>
            <form id="payDebtForm">
                <input type="hidden" id="debtId">
                <label>المبلغ المتبقي: <span id="remainingAmount"></span></label>
                <label>المبلغ المدفوع:</label>
                <input type="number" id="payAmount" step="0.01" required>
                <button type="submit" class="btn-primary">تسديد</button>
                <button type="button" class="btn-cancel" onclick="closePayDebtModal()">إلغاء</button>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let debts = [];
        let customers = [];

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadCurrentUser();
            loadDebtsSummary();
            loadDebtsTable();
            document.getElementById('reportDate').valueAsDate = new Date();
        });

        function loadDebtsSummary() {
            debts = JSON.parse(localStorage.getItem('debts')) || [];
            customers = JSON.parse(localStorage.getItem('customers')) || [];
            let totalDebt = 0;
            let debtorsCount = 0;
            const uniqueDebtors = new Set();
            debts.forEach(d => {
                if (d.remaining > 0) {
                    totalDebt += d.remaining;
                    uniqueDebtors.add(d.customerId);
                }
            });
            document.getElementById('debtorsCount').innerText = uniqueDebtors.size;
            document.getElementById('totalDebts').innerText = totalDebt.toFixed(2) + ' دج';
        }

        function loadDebtsTable() {
            const tbody = document.getElementById('debtsTableBody');
            tbody.innerHTML = '';
            debts.forEach(d => {
                if (d.remaining > 0) {
                    const customer = customers.find(c => c.id == d.customerId);
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${customer ? customer.name : 'غير معروف'}</td>
                        <td>${d.amount}</td>
                        <td>${d.remaining}</td>
                        <td>${d.dueDate || ''}</td>
                        <td>${d.status}</td>
                        <td><button class="btn-pay-debt" onclick="showPayDebtModal(${d.id})"><i class="fas fa-money-bill"></i> تسديد</button></td>
                    `;
                }
            });
        }

        function showPayDebtModal(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (debt) {
                document.getElementById('debtId').value = debt.id;
                document.getElementById('remainingAmount').innerText = debt.remaining + ' دج';
                document.getElementById('payAmount').value = debt.remaining;
                document.getElementById('payDebtModal').style.display = 'flex';
            }
        }

        document.getElementById('payDebtForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const debtId = parseInt(document.getElementById('debtId').value);
            const amount = parseFloat(document.getElementById('payAmount').value);
            const debtIndex = debts.findIndex(d => d.id === debtId);
            if (debtIndex !== -1) {
                debts[debtIndex].remaining -= amount;
                if (debts[debtIndex].remaining <= 0) debts[debtIndex].status = 'مدفوع كلياً';
                else debts[debtIndex].status = 'مدفوع جزئياً';
                localStorage.setItem('debts', JSON.stringify(debts));

                const customer = customers.find(c => c.id == debts[debtIndex].customerId);
                if (customer) {
                    customer.totalDebt -= amount;
                    localStorage.setItem('customers', JSON.stringify(customers));
                }

                let payments = JSON.parse(localStorage.getItem('debtPayments')) || [];
                payments.push({
                    id: Date.now(),
                    debtId: debtId,
                    amount: amount,
                    date: new Date().toISOString(),
                    cashier: getCurrentUser().username
                });
                localStorage.setItem('debtPayments', JSON.stringify(payments));

                closePayDebtModal();
                loadDebtsSummary();
                loadDebtsTable();
            }
        });

        function closePayDebtModal() {
            document.getElementById('payDebtModal').style.display = 'none';
        }

        function loadReport() {
            const type = document.getElementById('reportType').value;
            const date = document.getElementById('reportDate').value;
            const sales = JSON.parse(localStorage.getItem('sales')) || [];

            let filteredSales = [];
            const now = new Date(date);

            if (type === 'daily') filteredSales = sales.filter(s => s.date.split('T')[0] === date);
            else if (type === 'weekly') {
                const start = new Date(now);
                start.setDate(now.getDate() - now.getDay() + 1);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                filteredSales = sales.filter(s => {
                    const d = new Date(s.date);
                    return d >= start && d <= end;
                });
            } else if (type === 'monthly') {
                const month = now.getMonth() + 1;
                const year = now.getFullYear();
                filteredSales = sales.filter(s => {
                    const d = new Date(s.date);
                    return d.getMonth() + 1 === month && d.getFullYear() === year;
                });
            } else if (type === 'yearly') {
                const year = now.getFullYear();
                filteredSales = sales.filter(s => new Date(s.date).getFullYear() === year);
            }

            let totalSales = 0;
            filteredSales.forEach(s => totalSales += s.total);

            let html = `<h3>نتيجة التقرير</h3><p>إجمالي المبيعات: ${totalSales.toFixed(2)} دج</p>`;
            html += `<table class="data-table"><thead><tr><th>رقم الفاتورة</th><th>التاريخ</th><th>الزبون</th><th>الإجمالي</th></tr></thead><tbody>`;
            filteredSales.forEach(s => {
                const customer = customers.find(c => c.id == s.customerId);
                html += `<tr><td>${s.invoiceNumber}</td><td>${new Date(s.date).toLocaleString('ar-DZ')}</td><td>${customer ? customer.name : 'نقدي'}</td><td>${s.total}</td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('reportResult').innerHTML = html;
        }

        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
